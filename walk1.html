<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>walk</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=q1hz24YqUC7g84TRhAW3v8a52xq51B3472o9tPeF"></script>
    <link rel="stylesheet" href="walk.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    
</head>
<body onload="initTmap()">
  <span class="slideshow-container">
    <div class="slide">
        <i class='bx bx-subdirectory-right'></i>
        <div class="text">
            <div class="meter">320m</div>
            <div class="subText">신길슈퍼 방면</div>
        </div>
    </div>
  </span>
  <div id="map"></div>

    <script type="text/javascript">

      // 슬라이드쇼 코드
      var slideIndex = 0;
        var slideshowTimeout;

        function showSlides() {
            var slides = document.getElementsByClassName("slide");
            for (var i = 0; i < slides.length; i++) {
                slides[i].style.display = "none";
            }
            slideIndex++;
            if (slideIndex > slides.length) {
                slideIndex = 1;
            }
            slides[slideIndex - 1].style.display = "flex";
            if (slideIndex === slides.length) {
                // 마지막 슬라이드일 경우 슬라이드쇼 중지
                stopSlideshow();
            } else {
                slideshowTimeout = setTimeout(showSlides, 2000); // 2초마다 변경
            }
        }

        // 슬라이드쇼 시작
        showSlides();

        // 슬라이드쇼 종료 함수
        function stopSlideshow() {
            clearTimeout(slideshowTimeout);
        }

        var map;
      var marker_s, marker_e, marker_p1, marker_p2;
      var totalMarkerArr = [];
      var drawInfoArr = [];
      var resultdrawArr = [];

        // 페이지가 로딩이 된 후 호출하는 함수입니다.
        function initTmap(){
        // map 생성
        // Tmapv3.Map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다.
        var map = new Tmapv2.Map("map", { // 지도가 생성될 div
            center : new Tmapv2.LatLng(37.46671695320371, 126.93308346538122),
            width : "100%",	// 지도의 넓이
            height : "580px",	// 지도의 높이
            zoom : 16	// 지도 줌레벨
        });
        //2. 시작 심볼 찍기
        marker_s = new Tmapv2.Marker(
        {
        position: new Tmapv2.LatLng(37.46671695320371, 126.93308346538122),
        icon: "image/MyLocationMarker.png",
        iconSize: new Tmapv2.Size(20, 20),
        map: map
        }
        )
        // 도착
        marker_e = new Tmapv2.Marker(
              {
                position: new Tmapv2.LatLng(37.472184550611196, 126.93435885637831),
                icon: "image/EndLocationMarker.png",
                iconSize: new Tmapv2.Size(36, 50),
                map: map
              });

            // 3. 경로탐색 API 사용요청
            var headers = {};
            headers["appKey"] = "q1hz24YqUC7g84TRhAW3v8a52xq51B3472o9tPeF";

            $.ajax({
              method: "POST",
              headers: headers,
              url: "https://apis.openapi.sk.com/tmap/routes/pedestrian?version=1&format=json&callback=result",
              async: false,
              data: {
                "startX": "126.93308346538122",
                "startY": "37.46671695320371",
                "endX": "126.93435885637831",
                "endY": "37.472184550611196",
                "resCoordType": "EPSG3857",
                "startName": "출발지",
                "endName": "도착지"
              },
              success: function (response) {
                var resultData = response.features;
                var infoData = [];
                //기존 그려진 라인 & 마커가 있다면 초기화
                if (resultdrawArr.length > 0) {
                  for (var i in resultdrawArr) {
                    resultdrawArr[i]
                      .setMap(null);
                  }
                  resultdrawArr = [];
                }

                drawInfoArr = [];

                for (var i in resultData) { //for문 [S]
                  var geometry = resultData[i].geometry;
                  var properties = resultData[i].properties;
                  var polyline_;

                  let info = 
                  {
                    "coordinate" : geometry.coordinates,
                    "description" : properties.description
                  };

                  infoData.push(info);



                  if (geometry.type == "LineString") {
                    for (var j in geometry.coordinates) {
                      // 경로들의 결과값(구간)들을 포인트 객체로 변환
                      var latlng = new Tmapv2.Point(
                        geometry.coordinates[j][0],
                        geometry.coordinates[j][1]);
                      // 포인트 객체를 받아 좌표값으로 변환
                      var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
                        latlng);
                      // 포인트객체의 정보로 좌표값 변환 객체로 저장
                      var convertChange = new Tmapv2.LatLng(
                        convertPoint._lat,
                        convertPoint._lng);
                      // 배열에 담기
                      drawInfoArr.push(convertChange);
                    }
                  } else {
                    var markerImg = "";
                    var pType = "";
                    var size;

                    if (properties.pointType == "S") { //출발지 마커
                      markerImg = "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png";
                      pType = "S";
                      size = new Tmapv2.Size(24, 38);
                    } else if (properties.pointType == "E") { //도착지 마커
                      markerImg = "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png";
                      pType = "E";
                      size = new Tmapv2.Size(24, 38);
                    } else { //각 포인트 마커
                      markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
                      pType = "P";
                      size = new Tmapv2.Size(8, 8);
                    }

                    // 경로들의 결과값들을 포인트 객체로 변환
                    var latlon = new Tmapv2.Point(
                      geometry.coordinates[0],
                      geometry.coordinates[1]);

                    // 포인트 객체를 받아 좌표값으로 다시 변환
                    var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
                      latlon);

                    var routeInfoObj = {
                      markerImage: markerImg,
                      lng: convertPoint._lng,
                      lat: convertPoint._lat,
                      pointType: pType
                    };

                    // Marker 추가
                    marker_p = new Tmapv2.Marker(
                      {
                        position: new Tmapv2.LatLng(
                          routeInfoObj.lat,
                          routeInfoObj.lng),
                        icon: routeInfoObj.markerImage,
                        iconSize: size,
                        map: map
                      });
                  }
                }//for문 [E]
                drawLine(drawInfoArr);
                console.log(infoData);
                localStorage.setItem("navigation", JSON.stringify(infoData));
                console.log(JSON.parse(localStorage.getItem("navigation")));
                let navigation = JSON.parse(localStorage.getItem("navigation"));
                
                var reg=/\d{1,3}\m/g;
                console.log(navigation[0].description.match(reg)[0]);
              },
              error: function (request, status, error) {
                console.log("code:" + request.status + "\n"
                  + "message:" + request.responseText + "\n"
                  + "error:" + error);
              }
            });

          function addComma(num) {
            var regexp = /\B(?=(\d{3})+(?!\d))/g;
            return num.toString().replace(regexp, ',');
          }

          function drawLine(arrPoint) {
            var polyline_;

            polyline_ = new Tmapv2.Polyline({
              path: arrPoint,
              strokeColor: "#FFC700",
              strokeWeight: 4,
              map: map
            });
            resultdrawArr.push(polyline_);
          }
        }
  </script>
</body>
</html>
